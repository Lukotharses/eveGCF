/* 
 * THIS IS JUST A BACK-UP FILE   !! 2B deleted !!
 */
<div id="page"></div>
    <script id="entry-template" type="text/x-handlebars-template">
    
            <div class="ticket" id="ticketSample"><div class="logo">{{logo}}</div><div class="left"><p class="id">{{id}}</p>
                    <p class="sf_guard_user_id">{{sf_guard_user_id}}</p>
                    <p class="automatic">{{automatic}}</p>
                    <p class="transaction_id">{{transaction_id}}</p>
                    <p class="vat">{{vat}}</p>
                    <p class="value">{{value}}</p>
                    <p class="manifestation_id">{{manifestation_id}}</p>
                    <p class="gauge_id">{{gauge_id}}</p>
                    <p class="price_id">{{price_id}}</p>
                    <p class="price_name">{{price_name}}</p>
                    <p class="printed_at">{{printed_at}}</p>
                    <p class="barcode">{{barcode}}</p>
                    <p class="taxes">{{taxes}}</p>
                    <p class="auto_by_hold">{{auto_by_hold}}</p>
                    <p class="created_at">{{created_at}}</p>
                    <p class="updated_at">{{updated_at}}</p>
                    <p class="version">{{version}}</p>
                    <p class="Transaction.id">{{Transaction.id}}</p>
                    <p class="Transaction.sf_guard_user_id">{{Transaction.sf_guard_user_id}}</p>
                    <p class="Transaction.automatic">{{Transaction.automatic}}</p>
                    <p class="Transaction.type">{{Transaction.type}}</p>
                    <p class="Transaction.closed">{{Transaction.closed}}</p>
                    <p class="Transaction.send_an_email">{{Transaction.send_an_email}}</p>
                    <p class="Transaction.deposit">{{Transaction.deposit}}</p>
                    <p class="Transaction.with_shipment">{{Transaction.with_shipment}}</p>
                    <p class="Transaction.created_at">{{Transaction.created_at}}</p>
                    <p class="Transaction.updated_at">{{Transaction.updated_at}}</p>
                    <p class="Transaction.version">{{Transaction.version}}</p>
                    <p class="Manifestation.id">{{Manifestation.id}}</p>
                    <p class="Manifestation.sf_guard_user_id">{{Manifestation.sf_guard_user_id}}</p>
                    <p class="Manifestation.automatic">{{Manifestation.automatic}}</p>
                    <p class="Manifestation.event_id">{{Manifestation.event_id}}</p>
                    <p class="Manifestation.location_id">{{Manifestation.location_id}}</p>
                    <p class="Manifestation.happens_at">{{Manifestation.happens_at}}</p>
                    <p class="Manifestation.duration">{{Manifestation.duration}}</p>
                    <p class="Manifestation.description">{{Manifestation.description}}</p>
                    <p class="Manifestation.vat_id">{{Manifestation.vat_id}}</p>
                    <p class="Manifestation.online_limit">{{Manifestation.online_limit}}</p>
                    <p class="Manifestation.no_print">{{Manifestation.no_print}}</p>
                    <p class="Manifestation.blocking">{{Manifestation.blocking}}</p>
                    <p class="Manifestation.reservation_begins_at">{{Manifestation.reservation_begins_at}}</p>
                    <p class="Manifestation.reservation_ends_at">{{Manifestation.reservation_ends_at}}</p>
                    <p class="Manifestation.reservation_description">{{Manifestation.reservation_description}}</p>
                    <p class="Manifestation.reservation_optional">{{Manifestation.reservation_optional}}</p>
                    <p class="Manifestation.reservation_confirmed">{{Manifestation.reservation_confirmed}}</p>
                    <p class="Manifestation.voucherized">{{Manifestation.voucherized}}</p>
                    <p class="Manifestation.created_at">{{Manifestation.created_at}}</p>
                    <p class="Manifestation.updated_at">{{Manifestation.updated_at}}</p>
                    <p class="Manifestation.version">{{Manifestation.version}}</p>
                    <p class="Manifestation.Location.id">{{Manifestation.Location.id}}</p>
                    <p class="Manifestation.Location.name">{{Manifestation.Location.name}}</p>
                    <p class="Manifestation.Location.address">{{Manifestation.Location.address}}</p>
                    <p class="Manifestation.Location.postalcode">{{Manifestation.Location.postalcode}}</p>
                    <p class="Manifestation.Location.city">{{Manifestation.Location.city}}</p>
                    <p class="Manifestation.Location.country">{{Manifestation.Location.country}}</p>
                    <p class="Manifestation.Location.email">{{Manifestation.Location.email}}</p>
                    <p class="Manifestation.Location.email_no_newsletter">{{Manifestation.Location.email_no_newsletter}}</p>
                    <p class="Manifestation.Location.email_npai">{{Manifestation.Location.email_npai}}</p>
                    <p class="Manifestation.Location.npai">{{Manifestation.Location.npai}}</p>
                    <p class="Manifestation.Location.automatic">{{Manifestation.Location.automatic}}</p>
                    <p class="Manifestation.Location.description">{{Manifestation.Location.description}}</p>
                    <p class="Manifestation.Location.gauge_max">{{Manifestation.Location.gauge_max}}</p>
                    <p class="Manifestation.Location.place">{{Manifestation.Location.place}}</p>
                    <p class="Manifestation.Location.unlimited">{{Manifestation.Location.unlimited}}</p>
                    <p class="Manifestation.Location.auto_control">{{Manifestation.Location.auto_control}}</p>
                    <p class="Manifestation.Location.slug">{{Manifestation.Location.slug}}</p>
                    <p class="Manifestation.Location.created_at">{{Manifestation.Location.created_at}}</p>
                    <p class="Manifestation.Location.updated_at">{{Manifestation.Location.updated_at}}</p>
                    <p class="Manifestation.Event.id">{{Manifestation.Event.id}}</p>
                    <p class="Manifestation.Event.sf_guard_user_id">{{Manifestation.Event.sf_guard_user_id}}</p>
                    <p class="Manifestation.Event.automatic">{{Manifestation.Event.automatic}}</p>
                    <p class="Manifestation.Event.meta_event_id">{{Manifestation.Event.meta_event_id}}</p>
                    <p class="Manifestation.Event.event_category_id">{{Manifestation.Event.event_category_id}}</p>
                    <p class="Manifestation.Event.event_category_description">{{Manifestation.Event.event_category_description}}</p>
                    <p class="Manifestation.Event.staging">{{Manifestation.Event.staging}}</p>
                    <p class="Manifestation.Event.staging_label">{{Manifestation.Event.staging_label}}</p>
                    <p class="Manifestation.Event.writer">{{Manifestation.Event.writer}}</p>
                    <p class="Manifestation.Event.writer_label">{{Manifestation.Event.writer_label}}</p>
                    <p class="Manifestation.Event.duration">{{Manifestation.Event.duration}}</p>
                    <p class="Manifestation.Event.image_url">{{Manifestation.Event.image_url}}</p>
                    <p class="Manifestation.Event.display_by_default">{{Manifestation.Event.display_by_default}}</p>
                    <p class="Manifestation.Event.accounting_account">{{Manifestation.Event.accounting_account}}</p>
                    <p class="Manifestation.Event.slug">{{Manifestation.Event.slug}}</p>
                    <p class="Manifestation.Event.museum">{{Manifestation.Event.museum}}</p>
                    <p class="Manifestation.Event.created_at">{{Manifestation.Event.created_at}}</p>
                    <p class="Manifestation.Event.updated_at">{{Manifestation.Event.updated_at}}</p>
                    <p class="Manifestation.Event.MetaEvent.id">{{Manifestation.Event.MetaEvent.id}}</p>
                    <p class="Manifestation.Event.MetaEvent.hide_in_month_calendars">{{Manifestation.Event.MetaEvent.hide_in_month_calendars}}</p>
                    <p class="Manifestation.Event.MetaEvent.created_at">{{Manifestation.Event.MetaEvent.created_at}}</p>
                    <p class="Manifestation.Event.MetaEvent.updated_at">{{Manifestation.Event.MetaEvent.updated_at}}</p>
                    <p class="Manifestation.Event.MetaEvent.slug">{{Manifestation.Event.MetaEvent.slug}}</p>
                    <p class="Gauge.id">{{Gauge.id}}</p>
                    <p class="Gauge.workspace_id">{{Gauge.workspace_id}}</p>
                    <p class="Gauge.manifestation_id">{{Gauge.manifestation_id}}</p>
                    <p class="Gauge.value">{{Gauge.value}}</p>
                    <p class="Gauge.online">{{Gauge.online}}</p>
                    <p class="Gauge.onsite">{{Gauge.onsite}}</p>
                    <p class="Gauge.group_name">{{Gauge.group_name}}</p>
                    <p class="Gauge.created_at">{{Gauge.created_at}}</p>
                    <p class="Gauge.updated_at">{{Gauge.updated_at}}</p>
                    <p class="Gauge.Workspace.id">{{Gauge.Workspace.id}}</p>
                    <p class="Gauge.Workspace.name">{{Gauge.Workspace.name}}</p>
                    <p class="Gauge.Workspace.on_ticket">{{Gauge.Workspace.on_ticket}}</p>
                    <p class="Gauge.Workspace.seated">{{Gauge.Workspace.seated}}</p>
                    <p class="Gauge.Workspace.created_at">{{Gauge.Workspace.created_at}}</p>
                    <p class="Gauge.Workspace.updated_at">{{Gauge.Workspace.updated_at}}</p>
                </div>
                <div class="right"><p class="id">{{id}}</p>
                    <p class="sf_guard_user_id">{{sf_guard_user_id}}</p>
                    <p class="automatic">{{automatic}}</p>
                    <p class="transaction_id">{{transaction_id}}</p>
                    <p class="vat">{{vat}}</p>
                    <p class="value">{{value}}</p>
                    <p class="manifestation_id">{{manifestation_id}}</p>
                    <p class="gauge_id">{{gauge_id}}</p>
                    <p class="price_id">{{price_id}}</p>
                    <p class="price_name">{{price_name}}</p>
                    <p class="printed_at">{{printed_at}}</p>
                    <p class="barcode">{{barcode}}</p>
                    <p class="taxes">{{taxes}}</p>
                    <p class="auto_by_hold">{{auto_by_hold}}</p>
                    <p class="created_at">{{created_at}}</p>
                    <p class="updated_at">{{updated_at}}</p>
                    <p class="version">{{version}}</p>
                    <p class="Transaction.id">{{Transaction.id}}</p>
                    <p class="Transaction.sf_guard_user_id">{{Transaction.sf_guard_user_id}}</p>
                    <p class="Transaction.automatic">{{Transaction.automatic}}</p>
                    <p class="Transaction.type">{{Transaction.type}}</p>
                    <p class="Transaction.closed">{{Transaction.closed}}</p>
                    <p class="Transaction.send_an_email">{{Transaction.send_an_email}}</p>
                    <p class="Transaction.deposit">{{Transaction.deposit}}</p>
                    <p class="Transaction.with_shipment">{{Transaction.with_shipment}}</p>
                    <p class="Transaction.created_at">{{Transaction.created_at}}</p>
                    <p class="Transaction.updated_at">{{Transaction.updated_at}}</p>
                    <p class="Transaction.version">{{Transaction.version}}</p>
                    <p class="Manifestation.id">{{Manifestation.id}}</p>
                    <p class="Manifestation.sf_guard_user_id">{{Manifestation.sf_guard_user_id}}</p>
                    <p class="Manifestation.automatic">{{Manifestation.automatic}}</p>
                    <p class="Manifestation.event_id">{{Manifestation.event_id}}</p>
                    <p class="Manifestation.location_id">{{Manifestation.location_id}}</p>
                    <p class="Manifestation.happens_at">{{Manifestation.happens_at}}</p>
                    <p class="Manifestation.duration">{{Manifestation.duration}}</p>
                    <p class="Manifestation.description">{{Manifestation.description}}</p>
                    <p class="Manifestation.vat_id">{{Manifestation.vat_id}}</p>
                    <p class="Manifestation.online_limit">{{Manifestation.online_limit}}</p>
                    <p class="Manifestation.no_print">{{Manifestation.no_print}}</p>
                    <p class="Manifestation.blocking">{{Manifestation.blocking}}</p>
                    <p class="Manifestation.reservation_begins_at">{{Manifestation.reservation_begins_at}}</p>
                    <p class="Manifestation.reservation_ends_at">{{Manifestation.reservation_ends_at}}</p>
                    <p class="Manifestation.reservation_description">{{Manifestation.reservation_description}}</p>
                    <p class="Manifestation.reservation_optional">{{Manifestation.reservation_optional}}</p>
                    <p class="Manifestation.reservation_confirmed">{{Manifestation.reservation_confirmed}}</p>
                    <p class="Manifestation.voucherized">{{Manifestation.voucherized}}</p>
                    <p class="Manifestation.created_at">{{Manifestation.created_at}}</p>
                    <p class="Manifestation.updated_at">{{Manifestation.updated_at}}</p>
                    <p class="Manifestation.version">{{Manifestation.version}}</p>
                    <p class="Manifestation.Location.id">{{Manifestation.Location.id}}</p>
                    <p class="Manifestation.Location.name">{{Manifestation.Location.name}}</p>
                    <p class="Manifestation.Location.address">{{Manifestation.Location.address}}</p>
                    <p class="Manifestation.Location.postalcode">{{Manifestation.Location.postalcode}}</p>
                    <p class="Manifestation.Location.city">{{Manifestation.Location.city}}</p>
                    <p class="Manifestation.Location.country">{{Manifestation.Location.country}}</p>
                    <p class="Manifestation.Location.email">{{Manifestation.Location.email}}</p>
                    <p class="Manifestation.Location.email_no_newsletter">{{Manifestation.Location.email_no_newsletter}}</p>
                    <p class="Manifestation.Location.email_npai">{{Manifestation.Location.email_npai}}</p>
                    <p class="Manifestation.Location.npai">{{Manifestation.Location.npai}}</p>
                    <p class="Manifestation.Location.automatic">{{Manifestation.Location.automatic}}</p>
                    <p class="Manifestation.Location.description">{{Manifestation.Location.description}}</p>
                    <p class="Manifestation.Location.gauge_max">{{Manifestation.Location.gauge_max}}</p>
                    <p class="Manifestation.Location.place">{{Manifestation.Location.place}}</p>
                    <p class="Manifestation.Location.unlimited">{{Manifestation.Location.unlimited}}</p>
                    <p class="Manifestation.Location.auto_control">{{Manifestation.Location.auto_control}}</p>
                    <p class="Manifestation.Location.slug">{{Manifestation.Location.slug}}</p>
                    <p class="Manifestation.Location.created_at">{{Manifestation.Location.created_at}}</p>
                    <p class="Manifestation.Location.updated_at">{{Manifestation.Location.updated_at}}</p>
                    <p class="Manifestation.Event.id">{{Manifestation.Event.id}}</p>
                    <p class="Manifestation.Event.sf_guard_user_id">{{Manifestation.Event.sf_guard_user_id}}</p>
                    <p class="Manifestation.Event.automatic">{{Manifestation.Event.automatic}}</p>
                    <p class="Manifestation.Event.meta_event_id">{{Manifestation.Event.meta_event_id}}</p>
                    <p class="Manifestation.Event.event_category_id">{{Manifestation.Event.event_category_id}}</p>
                    <p class="Manifestation.Event.event_category_description">{{Manifestation.Event.event_category_description}}</p>
                    <p class="Manifestation.Event.staging">{{Manifestation.Event.staging}}</p>
                    <p class="Manifestation.Event.staging_label">{{Manifestation.Event.staging_label}}</p>
                    <p class="Manifestation.Event.writer">{{Manifestation.Event.writer}}</p>
                    <p class="Manifestation.Event.writer_label">{{Manifestation.Event.writer_label}}</p>
                    <p class="Manifestation.Event.duration">{{Manifestation.Event.duration}}</p>
                    <p class="Manifestation.Event.image_url">{{Manifestation.Event.image_url}}</p>
                    <p class="Manifestation.Event.display_by_default">{{Manifestation.Event.display_by_default}}</p>
                    <p class="Manifestation.Event.accounting_account">{{Manifestation.Event.accounting_account}}</p>
                    <p class="Manifestation.Event.slug">{{Manifestation.Event.slug}}</p>
                    <p class="Manifestation.Event.museum">{{Manifestation.Event.museum}}</p>
                    <p class="Manifestation.Event.created_at">{{Manifestation.Event.created_at}}</p>
                    <p class="Manifestation.Event.updated_at">{{Manifestation.Event.updated_at}}</p>
                    <p class="Manifestation.Event.MetaEvent.id">{{Manifestation.Event.MetaEvent.id}}</p>
                    <p class="Manifestation.Event.MetaEvent.hide_in_month_calendars">{{Manifestation.Event.MetaEvent.hide_in_month_calendars}}</p>
                    <p class="Manifestation.Event.MetaEvent.created_at">{{Manifestation.Event.MetaEvent.created_at}}</p>
                    <p class="Manifestation.Event.MetaEvent.updated_at">{{Manifestation.Event.MetaEvent.updated_at}}</p>
                    <p class="Manifestation.Event.MetaEvent.slug">{{Manifestation.Event.MetaEvent.slug}}</p>
                    <p class="Gauge.id">{{Gauge.id}}</p>
                    <p class="Gauge.workspace_id">{{Gauge.workspace_id}}</p>
                    <p class="Gauge.manifestation_id">{{Gauge.manifestation_id}}</p>
                    <p class="Gauge.value">{{Gauge.value}}</p>
                    <p class="Gauge.online">{{Gauge.online}}</p>
                    <p class="Gauge.onsite">{{Gauge.onsite}}</p>
                    <p class="Gauge.group_name">{{Gauge.group_name}}</p>
                    <p class="Gauge.created_at">{{Gauge.created_at}}</p>
                    <p class="Gauge.updated_at">{{Gauge.updated_at}}</p>
                    <p class="Gauge.Workspace.id">{{Gauge.Workspace.id}}</p>
                    <p class="Gauge.Workspace.name">{{Gauge.Workspace.name}}</p>
                    <p class="Gauge.Workspace.on_ticket">{{Gauge.Workspace.on_ticket}}</p>
                    <p class="Gauge.Workspace.seated">{{Gauge.Workspace.seated}}</p>
                    <p class="Gauge.Workspace.created_at">{{Gauge.Workspace.created_at}}</p>
                    <p class="Gauge.Workspace.updated_at">{{Gauge.Workspace.updated_at}}</p>
                </div></div>
        

</script>
<script>

                        
    var source   = $("#entry-template").html();
    var template = Handlebars.compile(source);

    var request = new XMLHttpRequest();
    request.open('GET', 'http://127.0.0.1/tck.php/ticket/14586/print?direct&json', false);
    request.onload = function () {
            var tickets = JSON.parse(this.response);
            var key;
            var ticket = tickets[0];

            html    = template(ticket);
            
            console.log('HTML '+ html);
            
            /*
            console.log(ticket.Manifestation.Event.id);

            var patt = /{{.*?}}/;
            var attList = document.getElementsByClassName("p").getElementsByTagName("p");
            for each (elmt in attList){
                if (patt.test(elmt.innerHtml)){
                    elmt.innerHtml=ticket[];
                }
            }

            patt.test()
            */

        };

    request.send();
    console.log('HTMLOUT'+ html);
    document.getElementById("page").innerHTML = html;
    
</script>

///PHP residu
                                <?php
//    var_dump(gettype($param));
//    $count = 0;
//    $notOpt = 0;
//    $optDispl = 0;
//    $optNotDispl = 0;    
//    foreach($param as $key => $value){
//        $count++;
//        $str = '<tr><td>'.$key.'</td><td><input type="checkbox" id="'.$key.'" checked=';
//        if($value['optional']&&$value['displayed']){
//            $str.=false;
//            $optDispl++;
//        }else if (! $value['optional']){
//            $str.='true disabled';
//            $notOpt++;
//        }else{
//            $optNotDispl++;
//            continue;
//            
//        }
//        $str.=' /></td></tr>';
//        echo $str;
//    }
//    var_dump($count, $notOpt, $optDispl, $optNotDispl);
                                $font = array("Lucida" => "Lucida", "Verdana" => "Verdana", "Helvetica" => "Helvetica", "Lucida-Console" => "Lucida Console");
//        foreach($param as $key => $value){
//            $str = '<li class="list-group-item"><label for="'.$key.'">'.$key.
//                    ' </label><input type="checkbox" id="'.$key.'" checked=';
//            
//            if(!$value['optional']){
//                //not an option
//                $str.='"1" disabled="1"';
//            }else if($value['displayed']){
//                //optional but displayed
//                $str .= '"0"';
//            }else continue; //skip the rest
//            //finish the form line
//            $str.='</input>';
//            $str.= '<select name="'.$key.'.font" id="'.$key.'.font">';
//            foreach ($font as $k => $v) {
//                $str.='<option value="'.$k.'">'.$v.'</option>';
//            }
//            $str.='</select>';
//            $str .='<select name="'.$key.'.size" id="'.$key.'.size">';
//            for ($i = 6; $i < 20; $i++) {
//                $str.='<option value="'.$i.'">'.$i.'</option>';
//            }
//            $str.='</select>';
//            $str.='</li>';
//            echo $str;
                                //another test with while
//                                $current = $param->current();
//                                $key = $param->key();
//                                echo $key;
//                                echo '  current ';
//                                var_dump($current->getRaw('optional'));
//                                var_dump($current);
//
//                                while ($param->valid()) {
//                                    $current = $param->current();
//                                    $key = $param->key();
//                                    $optional = $current->getRaw('optional');
//                                    $displayed = $current->getRaw('displayed');
//
//                                    $str = '<li class="list-group-item"><label for="' . $key . '">' . $key .
//                                            ' </label><input type="checkbox" id="' . $key;
//
//                                    if (!$optional) {
//                                        //not an option
//                                        $str.='checked disabled';
//                                    }else if (!$displayed)
//                                        continue; //skip the rest
//                                        
//                                    //finish the form line
//                                    $str.='>';
//                                    $str.= '<select name="' . $key . '.font" id="' . $key . '.font">';
//                                    foreach ($font as $k => $v) {
//                                        $str.='<option value="' . $k . '">' . $v . '</option>';
//                                    }
//                                    $str.='</select>';
//                                    $str .='<select name="' . $key . '.size" id="' . $key . '.size">';
//                                    for ($i = 6; $i < 20; $i++) {
//                                        $str.='<option value="' . $i . '">' . $i . '</option>';
//                                    }
//                                    $str.='</select>';
//                                    $str.='</li>';
//                                    echo $str;
//
//                                    $param->next();
//                                }
                                ?>
                                        
                                        
        //Handlebars.templates['templateTicket.html']
        //var source   = $("#entry-template").html();
        //var template = Handlebars.compile(source);

//    var request = new XMLHttpRequest();
//    request.open('GET', 'http://127.0.0.1/tck.php/ticket/14586/print?direct&json', false);
//    request.onload = function () {
//            var tickets = JSON.parse(this.response);
//            var key;
//            var ticket = tickets[0];
//
//            //html    = template(ticket);
//            html = Handlebars.templates['templateTicket.html'](ticket);
//            console.log('HTML '+ html);
//        };
//
//    request.send();
//    console.log('HTMLOUT'+ html);
//    document.getElementById("testing").innerHTML = html;



//customize via form
<form class="form-inline">
                            <ul class="list-group">
                                <h4>Elements imposés</h4>
                                <?php
                                $breaker = true;
                                foreach ($param as $key => $value) {
                                    if ($breaker && $value['optional']) {
                                        echo '<hr><h4>Elements optionnels </h4>';
                                        echo '<div class="scrolled">';
                                        $breaker = false;
                                    }
                                    echo '<li class="list-group-item">';
                                    //TODO ? put style in css
                                    echo $tckForm[$key]->renderRow(array('class' => "form-control input-sm"))
                                    . $tckForm[$key . '.font']->render(array('class' => "form-control input-sm", 'style' => 'width: 100px; float: right;'))
                                    . $tckForm[$key . '.size']->render(array('class' => "form-control input-sm", 'style' => 'float: right;'))
                                    ;
                                    echo '</li>';
                                }
                                ?>
                                </div>
                                <li class="list-group-item"><input type="submit" /></li>
                            </ul>
                     </form>
             
             
             
//
//printing a canvas
<?php decorate_with(false) ?>
<?php use_javascript('/js/customize/fabric.min.js');?>
<script type="text/javascript" src="/js/customize/jquery-1.11.2.js"></script>
<script type="text/javascript" src="/js/customize/fabric.min.js"></script>

<div id="section-to-print">
    <canvas id="rebuildCanvas" style="border:1px solid #000000;" width="400" height="300">
     come again !
    </canvas>
</div>
<script>
var myTck = '{"objects":[{"type":"text","originX":"left","originY":"top","left":188,"top":71,"width":64.26,"height":15.82,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":1,"scaleY":1,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","transformMatrix":null,"skewX":0,"skewY":0,"text":"hello world","fontSize":14,"fontWeight":"normal","fontFamily":"Times New Roman","fontStyle":"normal","lineHeight":1.16,"underline":false,"overline":false,"linethrough":false,"textAlign":"left","textBackgroundColor":"","charSpacing":0,"styles":null,"name":"trololilol"},{"type":"text","originX":"left","originY":"top","left":183,"top":190,"width":150.2,"height":45.2,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":1,"scaleY":1,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","transformMatrix":null,"skewX":0,"skewY":0,"text":"hello two","fontSize":40,"fontWeight":"normal","fontFamily":"Times New Roman","fontStyle":"normal","lineHeight":1.16,"underline":false,"overline":false,"linethrough":false,"textAlign":"left","textBackgroundColor":"","charSpacing":0,"styles":null},{"type":"image","originX":"left","originY":"top","left":0,"top":0,"width":16,"height":11,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":0,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":0.5,"scaleY":0.5,"angle":0,"flipX":true,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","transformMatrix":null,"skewX":0,"skewY":0,"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet","src":"http://127.0.0.1/images/breizhoneg.png","filters":[]}],"background":"rgba(0, 0, 0, 0)"}';
var rebuildCanvas = new fabric.StaticCanvas('rebuildCanvas');
rebuildCanvas.loadFromJSON(myTck, function() { rebuildCanvas.renderAll(); },function(o,object){console.log(o+' '+object);});

</script>
<script type="text/javascript" src="/js/print-tickets.js"></script>



//back text control
<div class ="canControls">
            <div id="text-controls">
            <p>Select an object on the template to activate controls below</p>
            <textarea rows="3" columns="80"></textarea><br>
            <label for="font-family" style="display:inline-block">Font type:</label>
            <select id="font-family" class="btn-object-choice">
              <option value="arial">Arial</option>
              <option value="arial narrow">Arial Narrow</option>
              <option value="helvetica" selected="">Helvetica</option>
              <option value="verdana">Verdana</option>
              <option value="georgia">Georgia</option>
              <option value="courier">Courier</option>
              <option value="impact">Impact</option>
            </select>
            <br>
            <label for="text-align" style="display:inline-block">Text align:</label>
            <select id="text-align" class="btn-object-action">
              <option value="Left">Left</option>
              <option value="Center">Center</option>
              <option value="Right">Right</option>
              <option value="Justify">Justify</option>
            </select>
            <div>
              <label for="text-font-size">Font size:</label>
              <input value="" min="6" max="120" step="1" id="text-font-size" class="btn-object-action" bind-value-to="fontSize" type="range">
            </div>
            <div>
              <label for="text-line-height">Line height:</label>
              <input value="" min="1" max="5" step="0.1" id="text-line-height" class="btn-object-action" bind-value-to="lineHeight" type="range">
            </div>
            <div>
              <label for="text-char-spacing">Char spacing:</label>
              <input value="" min="-200" max="800" step="10" id="text-char-spacing" class="btn-object-action" bind-value-to="charSpacing" type="range">
            </div>
            <button type="button" class="btn-object-action" id="text-cmd-italic" onclick="toggleBold()">
              Bold
            </button>
            <button type="button" class="btn-object-action" id="text-cmd-italic" onclick="toggleItalic()">
              Italic
            </button>
            <button type="button" class="btn-object-action" id="text-cmd-underline" onclick="toggleUnderline()">
              Underline
            </button>
            <button type="button" class="btn-object-action" id="text-cmd-linethrough" onclick="toggleLinethrough()">
              Linethrough
            </button>
            <button type="button" class="btn-object-action" id="text-cmd-overline" onclick="toggleOverline()">
              Overline
            </button>
          </div>
        </div>



// functions to check overlap etc
//stackoverflow IS BAD BAD
//	// Don't allow objects off the canvas
//	if(targ.getLeft() < snap) {
//		targ.setLeft(0);
//	}
//
//	if(targ.getTop() < snap) {
//		targ.setTop(0);
//	}
//
//	if((targ.getWidth() + targ.getLeft()) > (canvasWidth - snap)) {
//		targ.setLeft(canvasWidth - targ.getWidth());
//	}
//
//	if((targ.getHeight() + targ.getTop()) > (canvasHeight - snap)) {
//		targ.setTop(canvasHeight - targ.getHeight());
//	}
//    
//    
//        canvas.forEachObject(function (obj) {
//            if (obj === targ) return;
//
//            // If objects intersect
//            if (targ.intersectsWithObject(obj)) {
//
//                var distX = ((obj.getLeft() + obj.getWidth()) / 2) - ((targ.getLeft() + targ.getWidth()) / 2);
//                var distY = ((obj.getTop() + obj.getHeight()) / 2) - ((targ.getTop() + targ.getHeight()) / 2);
//
//                // Set new position
//                findNewPos(distX, distY, targ, obj);
//                
//            }
//            
//            
//            });
//        
//        targ.setCoords();
//
//	// If objects still overlap
//
//	var outerAreaLeft = null,
//        outerAreaTop = null,
//        outerAreaRight = null,
//        outerAreaBottom = null;
//
//	canvas.forEachObject(function (obj) {
//		if (obj === targ) return;
//
//		if (targ.isContainedWithinObject(obj) || targ.intersectsWithObject(obj) || obj.isContainedWithinObject(targ)) {
//
//			var intersectLeft = null,
//			intersectTop = null,
//			intersectWidth = null,
//			intersectHeight = null,
//			intersectSize = null,
//			targetLeft = targ.getLeft(),
//			targetRight = targetLeft + targ.getWidth(),
//			targetTop = targ.getTop(),
//			targetBottom = targetTop + targ.getHeight(),
//			objectLeft = obj.getLeft(),
//			objectRight = objectLeft + obj.getWidth(),
//			objectTop = obj.getTop(),
//			objectBottom = objectTop + obj.getHeight();
//
//			// Find intersect information for X axis
//			if(targetLeft >= objectLeft && targetLeft <= objectRight) {
//				intersectLeft = targetLeft;
//				intersectWidth = obj.getWidth() - (intersectLeft - objectLeft);
//
//			} else if(objectLeft >= targetLeft && objectLeft <= targetRight) {
//				intersectLeft = objectLeft;
//				intersectWidth = targ.getWidth() - (intersectLeft - targetLeft);
//			}
//
//			// Find intersect information for Y axis
//			if(targetTop >= objectTop && targetTop <= objectBottom) {
//				intersectTop = targetTop;
//				intersectHeight = obj.getHeight() - (intersectTop - objectTop);
//
//			} else if(objectTop >= targetTop && objectTop <= targetBottom) {
//				intersectTop = objectTop;
//				intersectHeight = targ.getHeight() - (intersectTop - targetTop);
//			}
//
//			// Find intersect size (this will be 0 if objects are touching but not overlapping)
//			if(intersectWidth > 0 && intersectHeight > 0) {
//				intersectSize = intersectWidth * intersectHeight;
//			}
//
//			// Set outer snapping area
//			if(obj.getLeft() < outerAreaLeft || outerAreaLeft == null) {
//				outerAreaLeft = obj.getLeft();
//			}
//
//			if(obj.getTop() < outerAreaTop || outerAreaTop == null) {
//				outerAreaTop = obj.getTop();
//			}
//
//			if((obj.getLeft() + obj.getWidth()) > outerAreaRight || outerAreaRight == null) {
//				outerAreaRight = obj.getLeft() + obj.getWidth();
//			}
//
//			if((obj.getTop() + obj.getHeight()) > outerAreaBottom || outerAreaBottom == null) {
//				outerAreaBottom = obj.getTop() + obj.getHeight();
//			}
//
//			// If objects are intersecting, reposition outside all shapes which touch
//			if(intersectSize) {
//				var distX = (outerAreaRight / 2) - ((targ.getLeft() + targ.getWidth()) / 2);
//				var distY = (outerAreaBottom / 2) - ((targ.getTop() + targ.getHeight()) / 2);
//
//				// Set new position
//				findNewPos(distX, distY, targ, obj);
//			}
//		}
//        
//	});
//        

        
//		
// 
    
    
    //var mouse_pos = { x: 0, y: 0 };
//    canvas.on('mouse:move', function(options) {
//            mouse_pos = canvas.getPointer(options.e);
//            console.log(mouse_pos.x);
//        });
    
//    canvas.on('mouse:up', function(event){
//        console.log(event.target);
//        canvas.trigger('object:moving', event);
//    });


   
//    canvas.on('object:moving', function(e){
//        var targ = e.target;
//        //targ.setCoords();
//        var top = targ.getTop(), left = targ.getLeft();
//        console.log("top: "+top+" left: "+left+" "+targ.get);
//        targ.setCoords();
//        console.log(targ.isOnScreen(true));
//        if (!targ.isOnScreen(true)){
//            targ.setTop(top);
//            targ.setLeft(left);
//        }
//    });
//    
//    function stopDragging(element) {
//    element.lockMovementX = true;
//    element.lockMovementY = true;
//    }
//    
//    var upperCanvas = canvas.getSelectionElement();
//    $(upperCanvas).on('mouseout', function(e) {
//        stopDragging(e.target);
//    });
    
//    canvas.on('mouse:out', function(event){
//          console.log(event.target);
//          canvas.fire('mouse:up', event);
//          canvas.trigger('object:modified',{target : canvas.getActiveObject()});
//          canvas.trigger('object:mouseup', {target : canvas.getActiveObject()});
//        var selected = canvas.getActiveObject();
//        trigger('mouse:down', event);
//        if (selected){
//            canvas.setActiveObject(selected);
//        }
//    });

//
//    function findNewPos(distX, distY, target, obj) {
//	// See whether to focus on X or Y axis
//	if(Math.abs(distX) > Math.abs(distY)) {
//		if (distX > 0) {
//			target.setLeft(obj.getLeft() - target.getWidth());
//		} else {
//			target.setLeft(obj.getLeft() + obj.getWidth());
//		}
//	} else {
//		if (distY > 0) {
//			target.setTop(obj.getTop() - target.getHeight());
//		} else {
//			target.setTop(obj.getTop() + obj.getHeight());
//		}
//	}
//}
//
//    
//    var snap = 1; //pixels to snap
//    var canvasWidth = canvas.getWidth();
//    var canvasHeight = canvas.getHeight();
//    
//

// 


    //text controls
/* generic function is working, 2B removed
    function isBold(item){
        $(item).hasClass("true")
    }
    
    function toggleBold(item) {
        $(item).toggleClass("true");
        if ($(item).hasClass("true")) {
            canvas.getActiveObject().set("fontWeight", "bold");
        } else {
            canvas.getActiveObject().set("fontWeight", "normal");
        }
        canvas.renderAll();
    }
*/ 

/*canvas
.editor{
    width: 150mm;
    height: 50mm;
}
*/
/*interact*/
/*#drag-1, #drag-2 {
  width: 25%;
  height: 100%;
  min-height: 6.5em;
  margin: 10%;

  background-color: #29e;
  color: white;

  border-radius: 0.75em;
  padding: 4%;

  -webkit-transform: translate(0px, 0px);
          transform: translate(0px, 0px);
}

#drag-me::before {
  content: "#" attr(id);
  font-weight: bold;
}*/


public function executeCustomize(sfWebRequest $request)
  {
          
          function comPar2($a, $b){
              if($a['optional']==$b['optional']){
                  return 0;
              }
              return ($a['optional'])?1:-1;
          }
          
          //$this->form = new CustomTicketForm();
          $fileJson = fopen(__DIR__.'/../config/ticketParam.json', 'r');
          $jsonParam = json_decode(fread($fileJson,filesize(dirname(__FILE__).'/../config/ticketParam.json')), TRUE);
          fclose($fileJson);
          uasort($jsonParam, 'comPar2');
          
          $size = array();
            for ($i = 6; $i < 20; $i++) {
                $size[$i] = $i;
            }
          $this->tckForm =new CustomTicketForm(array(),array('param'=>$jsonParam));
          $this->param = $jsonParam;
          $this->font = array("Arial"=>"Arial", "Lucida"=>"Lucida", "Helvetica"=>"Helvetica", "Lucida-Console"=>"Lucida Console");
          $this->size = $size;
  }
  
  
//customizeSuccess
<?php
use_stylesheet('/css/customize/bootstrap-mod.min.css');
use_javascript('/js/customize/bootstrap.min.js');
use_javascript('/js/customize/interact.js');
use_javascript('/js/customize/fabric.min.js');
//use_javascript('/js/customize/w3.js');
use_javascript('/js/customize/customFunc.js');
use_javascript('/js/customize/handlebars-v4.0.10.js');
use_javascript('/js/customize/jquery-1.11.2.js');
use_stylesheet('/css/customize/customize.css');
?>
<?php use_helper('I18N') ?>
<div class="bootstrap">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-4">
                <div id="menu-tkt" class="panel panel-primary">
                    <div class="panel-heading">
                        <h2 class="panel-title" title="title-menu-tkt">Modification du billet</h2>
                    </div>
                    <div class="panel-body">
                        <ul class="list-group">
                            <h4>Elements imposés</h4>
                            <?php
                            $breaker = true;
                            foreach ($param as $key => $value) {
                                if ($breaker && $value['optional']) {
                                    echo '<hr><h4>Elements optionnels </h4>';
                                    echo '<div class="scrolled">';
                                    $breaker = false;
                                }
                                echo '<li class="list-group-item">';
                                echo '<form class="form-inline">';
                                echo '<div class="row">';
                                //TODO ? put style in css
                                //$hasSuccess = ($value['optional'])?'':'has-success'; // in jquery
                                echo '<div class="input-group col-md-5">';
                                echo '<input type="text" class="form-control" title="' . $key . '" name="' . $key . '"  value="' . $key . '" disabled>';
                                echo ' <span class="input-group-addon">';
                                // not a option ?
                                if (!$value['optional']) {
                                    echo '<input class ="addLabelBox" type="checkbox" id="' . $key . '" checked disabled>';
                                    // optional but to display ?
                                } else if ($value['displayed']) {
                                    echo '<input class ="addLabelBox" type="checkbox" id="' . $key . '">';
                                    // throw away the rest
                                } else
                                    continue;
                                //go on with the options
                                //echo '</span>';
                                echo '</span>';
                                echo '</div>';
                                echo '<select id="' . $key . '.font" class="form-control fontSelection" title="Please choose a font" disabled>';
                                foreach ($font as $k => $v) {
                                    echo '<option value="' . $k . '">' . $v . '</option>';
                                }
                                echo '</select>';
                                echo '<select id="' . $key . '.size" class="form-control sizeSelection" title="Please choose a font size" disabled>';
                                foreach ($size as $k => $v) {
                                    echo '<option value="' . $k . '">' . $v . '</option>';
                                }
                                echo '</select>';
                                echo '</div>';

                                //echo '</div>';
                                echo '</form>';
                                echo '</li>';
                            }
                            echo '</ul>';
                            ?>
                            <li class="list-group-item"><input type="submit" /></li>
                        </ul>
                    </div>

                </div>

            </div>


            <div class="col-md-8">
                <div id="preview-tkt" class="panel panel-primary">
                    <div class="panel-heading">
                        <h2 class="panel-title" title="title-preview-tkt">Prévisualisation</h2>

                    </div>
                    <div class="panel-body">
                        <!--                        <div class="col-md-6">-->

                        <div class="editor">
                            <canvas id="tktCanvas">
                                Please wait for loading.
                                If nothing happens, kindly update your browser.
                            </canvas>
                            <button class="btn btn-success" id="serializer" type="button">serializer</button>
                            <button class="btn btn-success" id="resizer" type="button">resizer</button>
                        </div>
                    </div>

                    <!--                        </div>-->
                    <!--                        <div class="col-md-6">-->
                    <div class="panel-footer">For debug only
                        <div id="section-to-print">
                            <canvas id="rebuildCanvas" style="border:1px solid #000000;" width="400" height="300">
                                come again !
                            </canvas>
                        </div>
                        <button class="btn btn-success" id="reSerializer" type="button" disabled>rebuild</button>
                        <!--                        </div>-->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <! Please erase when done >
    <div id="testing">

    </div>






    <script>
        
        
        var canvas = new fabric.Canvas('tktCanvas');
        //canvas.setWidth("150mm", {'cssOnly': true});
        //canvas.setHeight("50mm", {'cssOnly': true});
        //canvas.renderAll();
        canvas.setWidth("900");
        canvas.setHeight("300");
        //canvas.setWidth( "<desired width>" );
        //canvas.setHeight( <desired height> );
        //canvas.calcOffset();
//        var styleCanvas = document.getElementsByTagName('canvas')[0];
//        styleCanvas.style.width  = '900px';
//        styleCanvas.style.height = '300px';
        var rect = new fabric.Rect({
        left: 100,
        top: 100,
        fill: 'red',
        width: 100,
        height: 100
      });
    canvas.add(rect);

        
        var objectOnCanvas = [];
        var rebuildCanvas = new fabric.StaticCanvas('rebuildCanvas');
        //image adding example
        //        fabric.Image.fromURL('/images/breizhoneg.png', function (oImg) {
        //               //scale image down, and flip it, before adding it onto canvas
        //               oImg.scale(0.5).setFlipX(true);
        //               canvas.add(oImg);
        //             });
        //        
        // create class for the text elements
        var TckLabel = fabric.util.createClass(fabric.Text, {
            initialize: function (text2Display, options) {
                this.callSuper('initialize', text2Display, options);
                options && this.set('name', options.name);
                this.set('hasControls', false);
                this.set('hasRotatingPoint', false);
                this.set('lockRotation', true);
            },
            toObject: function () {
                return fabric.util.object.extend(this.callSuper('toObject'), {name: this.name});
            }
        });



        // text adding examples
        //         var text = new fabric.Text('hello world', { fontSize: 14, left: 100, top: 100 });
        //         text.lockScalingX = true;
        //         text.lockScalingY = true;
        //         text.hasControls = false;

        // add parameter to object/JSON
        //         text.toObject = (function(toObject) {
        //                return function() {
        //                    return fabric.util.object.extend(toObject.call(this), {
        //                        name: this.name
        //                        });
        //                    };
        //                })(text.toObject);
        //         text.name = "trololilol";


        // text adding examples
        //         var text = new TckLabel("youhou !!!", { fontSize: 14, left: 100, top: 100, name: "UN_VACH_te_DE_SUPER_NOM" });
        //         canvas.add(text);
        //         var text2 = new fabric.Text('hello two', { left: 100, top: 100 });
        //         canvas.add(text2);

        //function to prevent object moving out of the canvas 
        canvas.on('object:moving', function (e) {
            var obj = e.target;
            // if object is too big ignore
            if (obj.currentHeight > obj.canvas.height || obj.currentWidth > obj.canvas.width) {
                return;
            }
            obj.setCoords();
            // top-left  corner
            if (obj.getBoundingRect().top < 0 || obj.getBoundingRect().left < 0) {
                obj.top = Math.max(obj.top, obj.top - obj.getBoundingRect().top);
                obj.left = Math.max(obj.left, obj.left - obj.getBoundingRect().left);
            }
            // bot-right corner
            if (obj.getBoundingRect().top + obj.getBoundingRect().height > obj.canvas.height || obj.getBoundingRect().left + obj.getBoundingRect().width > obj.canvas.width) {
                obj.top = Math.min(obj.top, obj.canvas.height - obj.getBoundingRect().height + obj.top - obj.getBoundingRect().top);
                obj.left = Math.min(obj.left, obj.canvas.width - obj.getBoundingRect().width + obj.left - obj.getBoundingRect().left);
            }
        });

        // prepare the ticket
        var myTck;
        document.getElementById("serializer").onclick = function () {
            myTck = JSON.stringify(canvas);
            console.log(myTck);
            console.log(canvas.toSVG());
            document.getElementById("reSerializer").disabled = false;
            
        };


        document.getElementById("reSerializer").onclick = function () {
            rebuildCanvas.loadFromJSON(myTck, function () {
                rebuildCanvas.renderAll();
            },
                    function (o, object) {
                        console.log(o + ' ' + object);
                    }
            );
        };

        
        //for test ! Size changer

        document.getElementById("resizer").onclick = function () {
            var sizWidth = canvas.getWidth();
            var sizHeight = canvas.getHeight();
            var zoom = 1
            if (sizWidth*1.5<1000){
                zoom = 1.5;
            }else{
                zoom = 0.75;
            }
            var styleCanvas = document.getElementsByTagName('canvas')[0];
            //styleCanvas.style.width = sizWidth +'px';
            //styleCanvas.style.height = sizHeight +'px';
            canvas.setWidth(sizWidth*zoom);
            canvas.setHeight(sizHeight*zoom);
            canvas.setZoom(zoom);
            canvas.getContext();
            canvas.renderAll();
        };
        
        function getNameFromOption(target) {
            var name = target.attr("id");
            var index = name.lastIndexOf(".");
            name = name.substring(0, index);
            return name;
        }

        function changeFont(target) {
            var name = getNameFromOption(target);
            var myObj = canvas.getObjects();
            var index = myObj.findIndex(obj => (obj.name === name));
            console.log(myObj[index]);
            myObj[index].fontFamily = target.val();
            canvas.renderAll();
            //canvas.trigger('object:moving', {target: myObj[index]});
        }

        function changeFontSize(target) {
            var name = getNameFromOption(target);
            var myObj = canvas.getObjects();
            var index = myObj.findIndex(obj => (obj.name === name));
            myObj[index].fontSize = target.val();
            canvas.renderAll();
            canvas.setActiveObject(canvas.item(index));
        }

        // put the css-tag and activate the options for the selected label
        function changeState(target)
        {
            var checkedClass = "has-success";
            target.closest("div").toggleClass(checkedClass);
            $('[id="' + target.attr("id") + '.font"]').prop("disabled", function (_, val) {
                return !val;
            });
            $('[id="' + target.attr("id") + '.size"]').prop("disabled", function (_, val) {
                return !val;
            });
        }


        function addText2Canvas(target)
        {
            var targetLabel = target.parent().prev().attr("value");
            var targetName = target.parent().prev().attr("name");
            var targetFontType = $('[id="' + target.attr("id") + '.font"]').val();
            var targetFontSize = $('[id="' + target.attr("id") + '.size"]').val();
            var lefty = fabric.util.getRandomInt(0, canvas.width);
            var topty = fabric.util.getRandomInt(0, canvas.height);
            var text2add = new TckLabel(targetLabel, {fontFamily: targetFontType, fontSize: targetFontSize, left: lefty, top: topty, name: targetName});
            canvas.add(text2add);
        }

        function checkedEvent() {
            $('.addLabelBox:checked').each(function () {
                changeState($(this));
                addText2Canvas($(this));
            });
            $('.addLabelBox').bind('click', function () {
                changeState($(this));
                addText2Canvas($(this));
            });
        }

        $(document).on("load", checkedEvent());
        $('.fontSelection').change(function () {
            changeFont($(this));
        });
        $('.sizeSelection').change(function () {
            changeFontSize($(this));
        });


    </script>
  